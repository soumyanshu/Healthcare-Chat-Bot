<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Healthcare Chatbot | Chat</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
  <style>
    body {
      background-image: url("/static/images/doc.jpg");
      background-size: cover;
      background-repeat: no-repeat;
      background-attachment: fixed;
    }

    #chat-container {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 20px;
      max-width: 700px;
      margin: auto;
      position: relative;
    }

    #chat-box {
      height: 350px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 15px;
      border-radius: 10px;
      background: linear-gradient(135deg, #e0f7fa, #f1f8e9); /* âœ… attractive color gradient */
    }

    .chat-message {
      margin-bottom: 10px;
    }

    .user-message {
      text-align: right;
      color: #007bff;
    }

    .bot-message {
      text-align: left;
      color: #28a745;
    }

    .icon-buttons {
      display: flex;
      gap: 15px;
    }

    .icon-buttons button {
      border: none;
      background: none;
      font-size: 20px;
      cursor: pointer;
    }

    .input-group button {
      height: 45px;
    }

    .chat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
  <div class="container">
    <a class="navbar-brand" href="/">ðŸ©ºMediBot</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link {% if request.path == '/' %}active{% endif %}" href="/">Home</a></li>
        <li class="nav-item"><a class="nav-link {% if request.path == '/features' %}active{% endif %}" href="/features">Features</a></li>
        <li class="nav-item"><a class="nav-link {% if request.path == '/about' %}active{% endif %}" href="/about">About</a></li>
        <li class="nav-item"><a class="nav-link {% if request.path == '/chatbot' %}active{% endif %}" href="/chatbot">Chatbot</a></li>
        {% if session.get('role') == 'admin' %}
          <li class="nav-item"><a class="nav-link" href="/admin/appointments">Manage Appointments</a></li>
          <li class="nav-item"><a class="nav-link" href="/logout">Logout</a></li>
        {% else %}
          <li class="nav-item"><a class="nav-link" href="/login_admin">Admin Login</a></li>
        {% endif %}
      </ul>
    </div>
  </div>
</nav>

<!-- Chat Area -->
<section class="py-5" data-aos="fade-up">
  <div id="chat-container">

    <div class="chat-header">
      <h2 class="mb-0">MediBot Assistant</h2>
      <div class="icon-buttons">
        <button onclick="startListening()" title="Mic"><i class="bi bi-mic-fill text-success"></i></button>
        <button onclick="toggleSpeaker()" title="Speaker"><i id="speaker-icon" class="bi bi-volume-up-fill text-primary"></i></button>
      </div>
    </div>

    <div id="chat-box" class="mb-3"></div>

    <form id="chat-form" class="input-group mb-3">
      <input type="text" id="user-input" class="form-control" placeholder="Type your message..." required>
      <button class="btn btn-primary" type="submit"><i class="bi bi-send-fill"></i></button>
    </form>

    <!-- Appointment Form -->
    <div id="appointment-form" style="display:none; margin-top: 20px;">
      <h5>Book Appointment</h5>
      <input type="text" id="appt-name" placeholder="Your Name" class="form-control mb-2">
      <input type="text" id="appt-contact" placeholder="Contact Info" class="form-control mb-2">
      <input type="datetime-local" id="appt-datetime" class="form-control mb-2">
      <textarea id="appt-issue" placeholder="Describe your issue" class="form-control mb-2"></textarea>
      <button onclick="submitAppointment()" class="btn btn-success">Submit Appointment</button>
    </div>

  </div>
</section>

<!-- Footer -->
<footer class="bg-primary text-white text-center py-3">
  <p>&copy; 2025 Healthcare Chatbot. All rights reserved.</p>
</footer>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
<script>AOS.init();</script>

<script>
  const chatBox = document.getElementById("chat-box");
  const chatForm = document.getElementById("chat-form");
  const userInput = document.getElementById("user-input");
  const speakerIcon = document.getElementById("speaker-icon");
  let speakerOn = true;

  chatForm.addEventListener("submit", async function(e) {
    e.preventDefault();
    const message = userInput.value.trim();
    if (message) {
      appendMessage("You", message, "user-message");
      userInput.value = "";

      const response = await fetch('/get_response', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: message })
      });
      const data = await response.json();

      appendMessage("Bot", data.reply, "bot-message");
      if (speakerOn) speakBotReply(data.reply);

      if (data.reply.toLowerCase().includes("appointment")) {
        document.getElementById("appointment-form").style.display = "block";
      }
    }
  });

  function appendMessage(sender, message, className) {
    const msg = document.createElement("div");
    msg.classList.add("chat-message", className);
    msg.innerHTML = `<strong>${sender}:</strong> ${message}`;
    chatBox.appendChild(msg);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function startListening() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();
    recognition.lang = "en-US";
    recognition.start();
    recognition.onresult = function(event) {
      const transcript = event.results[0][0].transcript;
      userInput.value = transcript;
      chatForm.requestSubmit();
    };
  }

  function speakBotReply(reply) {
    const cleanReply = reply.replace(/http\S+/g, '').replace(/More info:.*/i, '');
    const utter = new SpeechSynthesisUtterance(cleanReply);
    utter.lang = "en-US";
    speechSynthesis.speak(utter);
  }

  function toggleSpeaker() {
    speakerOn = !speakerOn;
    speakerIcon.classList.toggle("bi-volume-up-fill", speakerOn);
    speakerIcon.classList.toggle("bi-volume-mute-fill", !speakerOn);
    speakerIcon.classList.toggle("text-danger", !speakerOn);
  }

  async function submitAppointment() {
    const name = document.getElementById("appt-name").value;
    const contact = document.getElementById("appt-contact").value;
    const datetime = document.getElementById("appt-datetime").value;
    const issue = document.getElementById("appt-issue").value;

    if (!name || !contact || !datetime || !issue) {
      alert("Please fill in all fields.");
      return;
    }

    const response = await fetch("/book", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name, contact, datetime, issue })
    });

    const result = await response.json();
    alert(result.message || "Appointment submitted.");

    document.getElementById("appointment-form").style.display = "none";
    document.getElementById("appt-name").value = "";
    document.getElementById("appt-contact").value = "";
    document.getElementById("appt-datetime").value = "";
    document.getElementById("appt-issue").value = "";
  }
</script>
</body>
</html>
