<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin | Manage Appointments</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .table-actions button {
      margin-right: 5px;
    }
  </style>
</head>
<body>

<nav class="navbar navbar-dark bg-primary">
  <div class="container-fluid">
    <a class="navbar-brand" href="/">ðŸ©ºMediBot</a>
    <form class="d-flex">
      <a class="btn btn-light" href="/logout">Logout</a>
    </form>
  </div>
</nav>

<div class="container my-4">
  <h2 class="mb-4 text-center">Appointment Management</h2>

  <!-- Search Filter -->
  <div class="input-group mb-3">
    <input type="text" id="search-input" class="form-control" placeholder="Search by name, issue, or date">
    <button class="btn btn-secondary" onclick="exportToPDF()">Export PDF</button>
  </div>

  <div class="table-responsive">
    <table class="table table-bordered table-striped" id="appointments-table">
      <thead class="table-dark">
        <tr>
          <th>Name</th>
          <th>Contact</th>
          <th>Date/Time</th>
          <th>Issue</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for appt in appointments %}
        <tr>
          <td>{{ appt.name }}</td>
          <td>{{ appt.contact }}</td>
          <td>{{ appt.datetime }}</td>
          <td>{{ appt.issue }}</td>
          <td class="table-actions">
            <button class="btn btn-sm btn-warning" onclick="editAppointment({{ appt.id }}, this)">Edit</button>
            <button class="btn btn-sm btn-danger" onclick="deleteAppointment({{ appt.id }}, this)">Delete</button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
  // Search filter
  document.getElementById("search-input").addEventListener("input", function () {
    const filter = this.value.toLowerCase();
    document.querySelectorAll("#appointments-table tbody tr").forEach(row => {
      const text = row.innerText.toLowerCase();
      row.style.display = text.includes(filter) ? "" : "none";
    });
  });

  // Export table to PDF
  async function exportToPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.text("Appointment List", 10, 10);

    let y = 20;
    document.querySelectorAll("#appointments-table tbody tr").forEach(row => {
      const columns = Array.from(row.querySelectorAll("td")).map(td => td.innerText.trim());
      doc.text(columns.join(" | "), 10, y);
      y += 10;
    });

    doc.save("appointments.pdf");
  }

  function deleteAppointment(id, btn) {
    if (!confirm("Are you sure you want to delete this appointment?")) return;
    fetch(`/delete_appointment/${id}`, { method: "POST" })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          btn.closest("tr").remove();
        }
      });
  }

  function editAppointment(id, btn) {
    const row = btn.closest("tr");
    const cells = row.querySelectorAll("td");
    const name = prompt("Edit Name", cells[0].innerText);
    const contact = prompt("Edit Contact", cells[1].innerText);
    const datetime = prompt("Edit Date/Time", cells[2].innerText);
    const issue = prompt("Edit Issue", cells[3].innerText);

    const formData = new FormData();
    formData.append("name", name);
    formData.append("contact", contact);
    formData.append("datetime", datetime);
    formData.append("issue", issue);

    fetch(`/edit_appointment/${id}`, {
      method: "POST",
      body: formData
    }).then(res => res.json())
      .then(data => {
        if (data.success) {
          cells[0].innerText = name;
          cells[1].innerText = contact;
          cells[2].innerText = datetime;
          cells[3].innerText = issue;
        }
      });
  }
</script>

</body>
</html>
